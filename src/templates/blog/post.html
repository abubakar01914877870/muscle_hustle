{% extends "base.html" %}

{% block title %}{{ post.title }} - Blog - Muscle Hustle{% endblock %}

{% block content %}
<div class="blog-post-container">
    <nav class="blog-breadcrumb">
        <a href="{{ url_for('blog.blog_list') }}" class="breadcrumb-link">‚Üê Back to Blog</a>
    </nav>

    <article class="blog-post">
        <header class="blog-post-header">
            <h1 class="blog-post-title">{{ post.title }}</h1>
            <div class="blog-post-meta">
                <div class="blog-post-author">
                    <span class="author-label">By</span>
                    <span class="author-name">{{ post.author_name }}</span>
                </div>
                <div class="blog-post-date">
                    <span class="date-label">Published</span>
                    <time datetime="{{ (post.published_at or post.created_at).isoformat() }}">
                        {{ (post.published_at or post.created_at).strftime('%B %d, %Y') }}
                    </time>
                </div>
                {% if post.view_count > 0 %}
                <div class="blog-post-views">
                    <span class="views-count">{{ post.view_count }}</span>
                    <span class="views-label">views</span>
                </div>
                {% endif %}
            </div>

            {% if post.tags %}
            <div class="blog-post-tags">
                {% for tag in post.tags %}
                <span class="blog-tag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </header>

        <div class="blog-post-content">
            {% if post.content_type == 'html' %}
            {{ post.content|safe }}
            {% else %}
            <div class="plain-text-content">
                {{ post.content|replace('\n', '<br>')|safe }}
            </div>
            {% endif %}

            {% if post.images %}
            <div class="blog-post-images">
                {% for image in post.images %}
                <figure class="blog-image">
                    <img src="{{ image.download_url }}" alt="{{ image.alt_text or post.title }}" loading="lazy"
                        class="responsive-image"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="image-error-placeholder" style="display: none;">
                        <div class="image-error-icon">üñºÔ∏è</div>
                        <p>Image temporarily unavailable</p>
                        <small>{{ image.filename or 'Unknown file' }}</small>
                    </div>
                    {% if image.caption %}
                    <figcaption class="image-caption">{{ image.caption }}</figcaption>
                    {% endif %}
                </figure>
                {% endfor %}
            </div>
            {% endif %}

            {% if post.youtube_videos %}
            <div class="blog-post-videos">
                {% for video in post.youtube_videos %}
                <div class="youtube-video-container">
                    {% if video.title %}
                    <h3 class="video-title">{{ video.title }}</h3>
                    {% endif %}
                    <div class="youtube-embed" data-video-id="{{ video.video_id }}">
                        <div class="video-thumbnail" onclick="loadVideo(this)">
                            <img src="https://img.youtube.com/vi/{{ video.video_id }}/maxresdefault.jpg"
                                alt="Video thumbnail" loading="lazy"
                                onerror="this.src='https://img.youtube.com/vi/{{ video.video_id }}/hqdefault.jpg'">
                            <div class="play-button">
                                <svg width="68" height="48" viewBox="0 0 68 48">
                                    <path
                                        d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z"
                                        fill="#f00"></path>
                                    <path d="M 45,24 27,14 27,34" fill="#fff"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="video-loading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Loading video...</p>
                        </div>
                        <div class="video-error" style="display: none;">
                            <div class="video-error-icon">üìπ</div>
                            <p>Video temporarily unavailable</p>
                            <a href="https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank"
                                class="btn btn-secondary btn-sm">
                                Watch on YouTube
                            </a>
                        </div>
                        <div class="video-content" style="display: none;">
                            <!-- Video iframe will be loaded here -->
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </article>

    <nav class="blog-post-navigation">
        <a href="{{ url_for('blog.blog_list') }}" class="btn btn-secondary">
            ‚Üê Back to All Posts
        </a>
    </nav>
</div>

<style>
    .blog-post-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .blog-breadcrumb {
        margin-bottom: 2rem;
    }

    .breadcrumb-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .breadcrumb-link:hover {
        text-decoration: underline;
    }

    .blog-post {
        background: var(--color-surface);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .blog-post-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .blog-post-title {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
        margin: 0 0 1rem;
        color: var(--color-text);
    }

    .blog-post-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .blog-post-author,
    .blog-post-date,
    .blog-post-views {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .author-name,
    .views-count {
        font-weight: 600;
        color: var(--color-text);
    }

    .blog-post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .blog-tag {
        background: var(--primary-color);
        color: white;
        padding: 0.375rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .blog-post-content {
        padding: 2rem;
        line-height: 1.7;
        color: var(--color-text);
    }

    .blog-post-content h1,
    .blog-post-content h2,
    .blog-post-content h3,
    .blog-post-content h4,
    .blog-post-content h5,
    .blog-post-content h6 {
        margin: 2rem 0 1rem;
        color: var(--color-text);
    }

    .blog-post-content h1 {
        font-size: 2rem;
    }

    .blog-post-content h2 {
        font-size: 1.75rem;
    }

    .blog-post-content h3 {
        font-size: 1.5rem;
    }

    .blog-post-content h4 {
        font-size: 1.25rem;
    }

    .blog-post-content p {
        margin: 1rem 0;
    }

    .blog-post-content ul,
    .blog-post-content ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }

    .blog-post-content li {
        margin: 0.5rem 0;
    }

    .blog-post-content a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .blog-post-content a:hover {
        text-decoration: underline;
    }

    .blog-post-content a[target="_blank"]::after {
        content: " ‚Üó";
        font-size: 0.8em;
        opacity: 0.7;
    }

    .plain-text-content {
        white-space: pre-wrap;
        font-family: inherit;
    }

    .blog-post-images {
        margin: 2rem 0;
    }

    .blog-image {
        margin: 2rem 0;
        text-align: center;
    }

    .responsive-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .image-caption {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        font-style: italic;
    }

    .blog-post-videos {
        margin: 2rem 0;
    }

    .youtube-video-container {
        margin: 2rem 0;
    }

    .video-title {
        margin: 0 0 1rem;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .youtube-embed {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%;
        /* 16:9 aspect ratio */
        overflow: hidden;
        border-radius: 8px;
        cursor: pointer;
    }

    .youtube-embed iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }

    .video-thumbnail {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: opacity 0.3s ease;
    }

    .video-thumbnail:hover {
        opacity: 0.9;
    }

    .video-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.8;
        transition: all 0.3s ease;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }

    .video-thumbnail:hover .play-button {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.1);
    }

    .image-error-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
        background: var(--color-surface);
        color: var(--color-text-secondary);
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
    }

    .image-error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .image-error-placeholder p {
        margin: 0 0 0.5rem;
        font-weight: 500;
    }

    .image-error-placeholder small {
        opacity: 0.7;
        font-size: 0.8rem;
    }

    .video-loading,
    .video-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 315px;
        background: var(--color-surface);
        color: var(--color-text-secondary);
        border-radius: 8px;
        text-align: center;
        padding: 2rem;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .video-error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .video-error p {
        margin: 0 0 1rem;
        font-weight: 500;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .blog-post-navigation {
        margin: 2rem 0;
        text-align: center;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .blog-post-container {
            padding: 0 0.5rem;
        }

        .blog-post-header {
            padding: 1.5rem 1rem 1rem;
        }

        .blog-post-title {
            font-size: 2rem;
        }

        .blog-post-meta {
            flex-direction: column;
            gap: 0.5rem;
        }

        .blog-post-content {
            padding: 1.5rem 1rem;
        }

        .blog-post-content h1 {
            font-size: 1.75rem;
        }

        .blog-post-content h2 {
            font-size: 1.5rem;
        }

        .blog-post-content h3 {
            font-size: 1.25rem;
        }
    }

    @media (max-width: 480px) {
        .blog-post-title {
            font-size: 1.75rem;
        }

        .blog-post-content {
            padding: 1rem;
        }
    }

    /* Performance optimizations */
    .responsive-image {
        will-change: transform;
        transform: translateZ(0);
    }

    .blog-post {
        contain: layout style paint;
    }

    /* Reduce animations on low-end devices */
    @media (prefers-reduced-motion: reduce) {
        .responsive-image {
            transition: none;
        }

        .play-button {
            transition: none;
        }

        .video-thumbnail {
            transition: none;
        }
    }

    /* Optimize for touch devices */
    @media (hover: none) and (pointer: coarse) {
        .video-thumbnail:hover {
            opacity: 1;
        }

        .video-thumbnail:hover .play-button {
            transform: translate(-50%, -50%) scale(1);
        }
    }
</style>

<script>
    // YouTube video lazy loading optimization
    function loadVideo(thumbnail) {
        const container = thumbnail.parentElement;
        const videoId = container.getAttribute('data-video-id');
        const loadingDiv = container.querySelector('.video-loading');
        const errorDiv = container.querySelector('.video-error');
        const contentDiv = container.querySelector('.video-content');

        // Hide thumbnail and show loading
        thumbnail.style.display = 'none';
        loadingDiv.style.display = 'flex';

        // Create iframe with optimized parameters
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.loading = 'lazy';

        // Handle iframe load
        iframe.onload = function () {
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
            contentDiv.appendChild(iframe);
        };

        // Handle iframe error
        iframe.onerror = function () {
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'flex';
        };

        // Fallback timeout
        setTimeout(() => {
            if (loadingDiv.style.display !== 'none') {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'flex';
            }
        }, 10000);
    }

    // Enhanced image lazy loading with Intersection Observer
    document.addEventListener('DOMContentLoaded', function () {
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        // Add fade-in effect
                        img.style.opacity = '0';
                        img.style.transition = 'opacity 0.3s ease';

                        img.onload = function () {
                            this.style.opacity = '1';
                        };

                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.1
            });

            // Observe all images
            document.querySelectorAll('.responsive-image, .video-thumbnail img').forEach(img => {
                imageObserver.observe(img);
            });
        }

        // Preload critical resources
        const criticalImages = document.querySelectorAll('.blog-post-header img, .blog-post-content img:first-of-type');
        criticalImages.forEach(img => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'image';
            link.href = img.src;
            document.head.appendChild(link);
        });
    });
</script>
{% endblock %}