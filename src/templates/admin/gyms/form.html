{% extends "base.html" %}

{% block title %}{{ 'Edit' if gym else 'Add' }} Gym{% endblock %}

{% block content %}
<style>
    /* Override base styles to match home page theme */
    body {
        background: #F4F7FC !important;
    }

    .content-wrapper {
        background: transparent;
        padding: var(--space-32);
        padding-bottom: 120px;
        /* Extra space for fixed bottom navigation */
    }

    .theme-card {
        background: white;
        border-radius: 24px;
        padding: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 24px;
    }

    .theme-section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .theme-section-title svg {
        color: #FF734B;
    }

    .theme-input {
        background: #F9FAFB;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 15px;
        color: #1F2937;
        width: 100%;
        transition: all 0.2s;
    }

    .theme-input:focus {
        outline: none;
        border-color: #FF734B;
        background: white;
        box-shadow: 0 0 0 3px rgba(255, 115, 75, 0.1);
    }

    .theme-input::placeholder {
        color: #9CA3AF;
    }

    .theme-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
    }

    .theme-btn-primary {
        background: linear-gradient(135deg, #FF734B 0%, #FF5A2E 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .theme-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(255, 115, 75, 0.3);
    }

    .theme-btn-secondary {
        background: white;
        color: #6B7280;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        padding: 14px 24px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .theme-btn-secondary:hover {
        background: #F9FAFB;
        border-color: #D1D5DB;
    }

    .upload-zone {
        border: 2px dashed #E5E7EB;
        border-radius: 16px;
        padding: 40px 24px;
        text-align: center;
        background: linear-gradient(135deg, rgba(255, 115, 75, 0.03) 0%, rgba(255, 115, 75, 0.08) 100%);
        cursor: pointer;
        transition: all 0.3s;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: #FF734B;
        background: linear-gradient(135deg, rgba(255, 115, 75, 0.08) 0%, rgba(255, 115, 75, 0.12) 100%);
        transform: scale(1.01);
    }

    .upload-icon {
        width: 56px;
        height: 56px;
        margin: 0 auto 16px;
        background: linear-gradient(135deg, #FF734B 0%, #FF5A2E 100%);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .status-message {
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 16px;
        display: none;
    }

    .status-success {
        background: #ECFDF5;
        color: #059669;
        border: 1px solid #A7F3D0;
    }

    .status-error {
        background: #FEF2F2;
        color: #DC2626;
        border: 1px solid #FECACA;
    }

    .status-info {
        background: #EFF6FF;
        color: #2563EB;
        border: 1px solid #BFDBFE;
    }

    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    .image-card {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: #F9FAFB;
        aspect-ratio: 16/9;
        border: 1px solid #E5E7EB;
    }

    .image-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-title {
        font-size: 32px;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 8px;
    }

    .page-subtitle {
        font-size: 15px;
        color: #6B7280;
    }
</style>

<div class="content-wrapper">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">{{ 'Edit Gym' if gym else 'Add New Gym' }}</h1>
        <p class="page-subtitle">{{ 'Update gym information and upload images' if gym else 'Add a new gym to your
            directory' }}</p>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <!-- Basic Information Card -->
        <div class="theme-card">
            <h2 class="theme-section-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
                        clip-rule="evenodd" />
                </svg>
                Basic Information
            </h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label class="theme-label">Gym Name *</label>
                    <input type="text" name="name" required value="{{ gym.name if gym else '' }}" class="theme-input"
                        placeholder="Enter gym name">
                </div>
                <div>
                    <label class="theme-label">Phone Number *</label>
                    <input type="tel" name="phone" required value="{{ gym.phone if gym else '' }}" class="theme-input"
                        placeholder="+1 (555) 123-4567">
                </div>
            </div>

            <div>
                <label class="theme-label">Description</label>
                <textarea name="description" rows="3" class="theme-input"
                    placeholder="Brief description of the gym">{{ gym.description if gym else '' }}</textarea>
            </div>
        </div>

        <!-- Location Card -->
        <div class="theme-card">
            <h2 class="theme-section-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                        clip-rule="evenodd" />
                </svg>
                Location Details
            </h2>

            <div style="margin-bottom: 20px;">
                <label class="theme-label">Address</label>
                <input type="text" name="address" value="{{ gym.address if gym else '' }}" class="theme-input"
                    placeholder="123 Main St, City, State">
            </div>

            <div>
                <label class="theme-label">Google Map Link *</label>
                <input type="url" name="google_map_link" required value="{{ gym.google_map_link if gym else '' }}"
                    class="theme-input" placeholder="https://maps.app.goo.gl/...">
                <p style="margin-top: 8px; font-size: 13px; color: #6B7280;">
                    üìç Paste the full Google Maps share URL
                </p>
            </div>
        </div>

        <!-- Images Card -->
        <div class="theme-card">
            <h2 class="theme-section-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                        clip-rule="evenodd" />
                </svg>
                Gym Images
            </h2>

            <!-- Upload Zone -->
            <div id="upload_area" class="upload-zone">
                <input type="file" id="image_upload" accept="image/*" multiple style="display: none;">
                <div class="upload-icon">
                    <svg width="28" height="28" fill="white" viewBox="0 0 20 20">
                        <path
                            d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                    </svg>
                </div>
                <p style="font-size: 16px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">
                    Click to upload or drag and drop
                </p>
                <p style="font-size: 14px; color: #6B7280;">
                    PNG, JPG, WebP up to 10MB each
                </p>
            </div>

            <!-- Selected Files Display -->
            <div id="selected_files"
                style="display: none; margin-top: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px; border: 1px solid #E5E7EB;">
                <p style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">Selected Files:</p>
                <div id="files_list" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <button type="button" id="upload_btn" class="theme-btn-primary"
                style="width: 100%; margin-top: 16px; justify-content: center;">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                </svg>
                Upload to Cloudinary
            </button>

            <div id="upload_status" class="status-message"></div>

            <textarea name="images" id="images" rows="3" class="theme-input"
                placeholder="Cloudinary URLs will appear here after upload"
                style="font-family: monospace; font-size: 13px; margin-top: 16px;">{{ gym.images | join('\n') if gym and gym.images else '' }}</textarea>

            {% if gym and gym.images %}
            <div>
                <p style="font-size: 14px; font-weight: 600; color: #374151; margin-top: 24px; margin-bottom: 12px;">
                    Current Images ({{ gym.images | length }})
                </p>
                <div class="image-grid">
                    {% for image in gym.images %}
                    <div class="image-card">
                        <img src="{{ image }}" alt="Gym Image">
                        <div class="image-badge">{{ loop.index }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Admin Notes Card -->
        <div class="theme-card">
            <h2 class="theme-section-title">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
                Admin Notes
            </h2>
            <label class="theme-label">Internal Notes (Not visible to users)</label>
            <textarea name="admin_note" rows="2" class="theme-input"
                placeholder="Add any internal notes about this gym">{{ gym.admin_note if gym else '' }}</textarea>
        </div>

        <!-- Actions -->
        <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
            <a href="{{ url_for('admin_gym.list_gyms') }}" class="theme-btn-secondary" style="text-decoration: none;">
                Cancel
            </a>
            <button type="submit" class="theme-btn-primary">
                <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                        clip-rule="evenodd" />
                </svg>
                {{ 'Update Gym' if gym else 'Add Gym' }}
            </button>
        </div>
    </form>
</div>

<script>
    const uploadArea = document.getElementById('upload_area');
    const fileInput = document.getElementById('image_upload');
    const uploadBtn = document.getElementById('upload_btn');
    const statusDiv = document.getElementById('upload_status');
    const imagesTextarea = document.getElementById('images');
    const selectedFilesDiv = document.getElementById('selected_files');
    const filesList = document.getElementById('files_list');

    uploadArea.addEventListener('click', () => fileInput.click());

    // Show selected files when user picks files
    fileInput.addEventListener('change', () => {
        const files = fileInput.files;
        if (files.length > 0) {
            filesList.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 8px; border: 1px solid #E5E7EB;';
                fileItem.innerHTML = `
                    <svg width="16" height="16" fill="#FF734B" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                    </svg>
                    <span style="flex: 1; font-size: 14px; color: #374151;">${files[i].name}</span>
                    <span style="font-size: 12px; color: #6B7280;">${(files[i].size / 1024 / 1024).toFixed(2)} MB</span>
                `;
                filesList.appendChild(fileItem);
            }
            selectedFilesDiv.style.display = 'block';
        } else {
            selectedFilesDiv.style.display = 'none';
        }
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        // Trigger change event to show files
        fileInput.dispatchEvent(new Event('change'));
    });

    uploadBtn.addEventListener('click', async function () {
        const files = fileInput.files;

        if (files.length === 0) {
            showStatus('Please select at least one image', 'error');
            return;
        }

        showStatus(`Uploading ${files.length} image(s)...`, 'info');
        this.disabled = true;

        const existingUrls = imagesTextarea.value.trim().split('\n').filter(url => url.trim());

        for (let i = 0; i < files.length; i++) {
            const formData = new FormData();
            formData.append('image', files[i]);

            try {
                const response = await fetch('{{ url_for("admin_gym.upload_image") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    existingUrls.push(result.url);
                    showStatus(`Uploaded ${i + 1}/${files.length} images`, 'info');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                    break;
                }
            } catch (error) {
                showStatus(`Upload failed: ${error.message}`, 'error');
                break;
            }
        }

        imagesTextarea.value = existingUrls.join('\n');
        fileInput.value = '';
        selectedFilesDiv.style.display = 'none';
        this.disabled = false;
        showStatus(`‚úì Successfully uploaded ${files.length} image(s)!`, 'success');
    });

    function showStatus(message, type) {
        statusDiv.textContent = message;
        statusDiv.className = `status-message status-${type}`;
        statusDiv.style.display = 'block';

        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }
</script>
{% endblock %}