{% extends "base.html" %}

{% block title %}Create Blog Post - Admin{% endblock %}

{% block head %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
{% endblock %}

{% block content %}
<div class="blog-editor-container">
    <div class="editor-header">
        <div class="header-left">
            <h1 class="editor-title">Create New Post</h1>
        </div>
        <div class="header-right">
            <a href="{{ url_for('admin_blog.blog_dashboard') }}" class="btn-ghost">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <form method="POST" id="blogForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <input type="hidden" name="content_type" value="html">
        <input type="hidden" name="status" id="postStatus" value="draft">
        <input type="hidden" name="content" id="hiddenContent">

        <div class="editor-layout">
            <!-- Main Editor Area -->
            <div class="editor-main">
                <!-- Title Input -->
                <div class="title-section">
                    <input type="text" class="title-input" id="title" name="title" placeholder="Post title..." required>
                </div>

                <!-- Toolbar -->
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('heading')" title="Heading">
                            <i class="fas fa-heading"></i>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('paragraph')"
                            title="Paragraph">
                            <i class="fas fa-paragraph"></i>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('bold')" title="Bold">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('italic')" title="Italic">
                            <i class="fas fa-italic"></i>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('link')" title="Link">
                            <i class="fas fa-link"></i>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('image')" title="Image">
                            <i class="fas fa-image"></i>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('code')" title="Code Block">
                            <i class="fas fa-code"></i>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="insertSnippet('list')" title="List">
                            <i class="fas fa-list-ul"></i>
                        </button>
                    </div>
                    <div class="toolbar-divider"></div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <!-- Split Pane Editor -->
                <div class="split-pane">
                    <div class="pane editor-pane">
                        <div class="pane-header">
                            <span class="pane-title"><i class="fas fa-code"></i> HTML</span>
                        </div>
                        <div class="pane-content">
                            <textarea id="codeEditor"></textarea>
                        </div>
                    </div>
                    <div class="pane-divider"></div>
                    <div class="pane preview-pane">
                        <div class="pane-header">
                            <span class="pane-title"><i class="fas fa-eye"></i> Preview</span>
                        </div>
                        <div class="pane-content">
                            <div id="preview" class="preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="editor-sidebar">
                <!-- Publish Card -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h3 class="card-title">Publish</h3>
                    </div>
                    <div class="card-body">
                        <div class="status-badge status-draft">
                            <i class="fas fa-circle"></i> Draft
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-secondary" onclick="submitForm('draft')">
                                <i class="fas fa-save"></i> Save Draft
                            </button>
                            <button type="button" class="btn btn-primary" onclick="submitForm('published')">
                                <i class="fas fa-paper-plane"></i> Publish
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tips Card -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Tips</h3>
                    </div>
                    <div class="card-body">
                        <ul class="tips-list">
                            <li>Use <code>&lt;h2&gt;</code> for sections</li>
                            <li>Add images with <code>&lt;img&gt;</code></li>
                            <li>Use <code>&lt;style&gt;</code> for custom CSS</li>
                            <li>Preview updates automatically</li>
                        </ul>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h3 class="card-title">Shortcuts</h3>
                    </div>
                    <div class="card-body">
                        <div class="shortcut-list">
                            <div class="shortcut-item">
                                <span class="shortcut-key">Ctrl+S</span>
                                <span class="shortcut-desc">Save Draft</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-key">Ctrl+F</span>
                                <span class="shortcut-desc">Find</span>
                            </div>
                            <div class="shortcut-item">
                                <span class="shortcut-key">F11</span>
                                <span class="shortcut-desc">Fullscreen</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchtags.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/html-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">

<script>
    let editor;
    let previewTimeout;

    // Initialize CodeMirror
    document.addEventListener('DOMContentLoaded', function () {
        editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
            mode: 'htmlmixed',
            theme: 'material-darker',
            lineNumbers: true,
            lineWrapping: true,
            autoCloseTags: true,
            matchTags: { bothTags: true },
            foldGutter: true,
            gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
            extraKeys: {
                'Ctrl-Space': 'autocomplete',
                'Ctrl-S': function (cm) {
                    submitForm('draft');
                    return false;
                },
                'F11': function (cm) {
                    toggleFullscreen();
                }
            },
            indentUnit: 2,
            tabSize: 2,
            indentWithTabs: false
        });

        // Auto-update preview
        editor.on('change', function () {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(updatePreview, 300);
        });

        // Initial preview
        updatePreview();
    });

    // Update preview
    function updatePreview() {
        const content = editor.getValue();
        const title = document.getElementById('title').value;
        const preview = document.getElementById('preview');

        let html = '';
        if (title) {
            html += `<h1 class="preview-title">${escapeHtml(title)}</h1>`;
        }
        html += content;

        preview.innerHTML = html;
    }

    // HTML snippets
    const snippets = {
        heading: '<h2>Heading</h2>\n',
        paragraph: '<p>Your paragraph text here.</p>\n',
        bold: '<strong>bold text</strong>',
        italic: '<em>italic text</em>',
        link: '<a href="https://example.com">link text</a>',
        image: '<img src="https://example.com/image.jpg" alt="description" class="img-fluid">\n',
        code: '<pre><code>\n// Your code here\n</code></pre>\n',
        list: '<ul>\n  <li>Item 1</li>\n  <li>Item 2</li>\n  <li>Item 3</li>\n</ul>\n'
    };

    function insertSnippet(type) {
        const snippet = snippets[type];
        if (snippet) {
            editor.replaceSelection(snippet);
            editor.focus();
        }
    }

    // Fullscreen toggle
    function toggleFullscreen() {
        const container = document.querySelector('.blog-editor-container');
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                console.error('Fullscreen error:', err);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // Form submission
    function submitForm(status) {
        document.getElementById('postStatus').value = status;
        document.getElementById('hiddenContent').value = editor.getValue();
        document.getElementById('blogForm').submit();
    }

    // Escape HTML for title preview
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Prevent accidental navigation
    window.addEventListener('beforeunload', function (e) {
        if (editor.getValue().trim() || document.getElementById('title').value.trim()) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>

<style>
    /* Modern Editor Styles */
    .blog-editor-container {
        min-height: 100vh;
        background: #f8f9fa;
        padding: 0;
    }

    .editor-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .editor-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: #111827;
    }

    .btn-ghost {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        color: #6b7280;
        text-decoration: none;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .btn-ghost:hover {
        background: #f3f4f6;
        color: #111827;
    }

    .editor-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        padding: 1.5rem;
        max-width: 1280px;
        margin: 0 auto;
    }

    .editor-main {
        flex: 1 1 100%;
        min-width: 0;
    }

    .title-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .title-input {
        width: 100%;
        border: none;
        outline: none;
        font-size: 2rem;
        font-weight: 700;
        color: #111827;
        font-family: inherit;
    }

    .title-input::placeholder {
        color: #d1d5db;
    }

    .editor-toolbar {
        background: white;
        border-radius: 12px 12px 0 0;
        padding: 0.75rem 1rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
        border-bottom: 1px solid #e5e7eb;
    }

    .toolbar-group {
        display: flex;
        gap: 0.25rem;
    }

    .toolbar-btn {
        padding: 0.5rem 0.75rem;
        border: none;
        background: transparent;
        color: #6b7280;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .toolbar-btn:hover {
        background: #f3f4f6;
        color: #111827;
    }

    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: #e5e7eb;
    }

    .split-pane {
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 0 0 12px 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .pane {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        min-width: 0;
        min-height: 400px;
    }

    .pane-header {
        padding: 0.75rem 1rem;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
    }

    .pane-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pane-content {
        flex: 1;
        overflow: auto;
    }

    .pane-divider {
        height: 1px;
        background: #e5e7eb;
    }

    .CodeMirror {
        height: 100% !important;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 14px;
    }

    .CodeMirror-line {
        color: #e0e0e0 !important;
    }

    .CodeMirror-cursor {
        border-left: 1px solid #f8f8f2 !important;
    }

    .preview-content {
        padding: 2rem;
        max-width: 720px;
        margin: 0 auto;
    }

    .preview-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 2rem;
        color: #111827;
    }

    .preview-content h1,
    .preview-content h2,
    .preview-content h3 {
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #111827;
    }

    .preview-content p {
        margin: 1rem 0;
        line-height: 1.7;
        color: #374151;
    }

    .preview-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1.5rem 0;
    }

    .preview-content code {
        background: #f3f4f6;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.875em;
    }

    .preview-content pre {
        background: #1f2937;
        color: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
    }

    .editor-sidebar {
        flex: 1 1 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        align-content: start;
    }

    .sidebar-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .card-title {
        font-size: 0.875rem;
        font-weight: 600;
        margin: 0;
        color: #111827;
    }

    .card-body {
        padding: 1.25rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }

    .status-draft {
        background: #f3f4f6;
        color: #6b7280;
    }

    .button-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
    }

    .tips-list {
        list-style: none;
        padding: 0;
        margin: 0;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .tips-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .tips-list li:last-child {
        border-bottom: none;
    }

    .tips-list code {
        background: #f3f4f6;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.8125rem;
        color: #2563eb;
    }

    .shortcut-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .shortcut-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
    }

    .shortcut-key {
        background: #f3f4f6;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.75rem;
        color: #374151;
    }

    .shortcut-desc {
        color: #6b7280;
    }

    /* Fullscreen mode */
    .blog-editor-container:fullscreen {
        background: white;
    }

    .blog-editor-container:fullscreen .split-pane {
        height: calc(100vh - 200px);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .editor-sidebar {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .split-pane {
            flex-direction: column;
            height: auto;
        }

        .pane {
            min-height: 400px;
        }

        .pane-divider {
            display: none;
        }
    }
</style>
{% endblock %}