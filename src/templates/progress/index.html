{% extends "base.html" %}

{% block title %}Progress Tracker - Muscle Hustle{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='progress.css') }}">
{% endblock %}

{% block content %}
    <!-- Add Progress Entry Form -->
    <section class="form-section">
      <h2>Add Progress Entry</h2>
      
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="success-message show">
              <span>‚úì</span>
              <span>{{ message }}</span>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      <form id="progressForm" method="POST" action="{{ url_for('progress.add_entry') }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="weight">Weight (kg) *</label>
            <input type="number" id="weight" name="weight" class="form-control" step="0.1" min="0" required placeholder="e.g., 75.5">
          </div>
          <div class="form-group">
            <label class="form-label" for="body_fat">Body Fat %</label>
            <input type="number" id="body_fat" name="body_fat" class="form-control" step="0.1" min="0" max="100" placeholder="e.g., 18.5">
          </div>
          <div class="form-group">
            <label class="form-label" for="water_intake">Water Intake (L)</label>
            <input type="number" id="water_intake" name="water_intake" class="form-control" step="0.1" min="0" placeholder="e.g., 2.5">
          </div>
          <div class="form-group">
            <label class="form-label" for="chest">Chest (cm)</label>
            <input type="number" id="chest" name="chest" class="form-control" step="0.1" min="0" placeholder="e.g., 95.5">
          </div>
          <div class="form-group">
            <label class="form-label" for="waist">Waist (cm)</label>
            <input type="number" id="waist" name="waist" class="form-control" step="0.1" min="0" placeholder="e.g., 80.0">
          </div>
          <div class="form-group">
            <label class="form-label" for="hips">Hips (cm)</label>
            <input type="number" id="hips" name="hips" class="form-control" step="0.1" min="0" placeholder="e.g., 95.0">
          </div>
          <div class="form-group">
            <label class="form-label" for="arms">Arms (cm)</label>
            <input type="number" id="arms" name="arms" class="form-control" step="0.1" min="0" placeholder="e.g., 35.0">
          </div>
          <div class="form-group">
            <label class="form-label" for="thighs">Thighs (cm)</label>
            <input type="number" id="thighs" name="thighs" class="form-control" step="0.1" min="0" placeholder="e.g., 55.0">
          </div>
          <div class="form-group">
            <label class="form-label" for="photo">Progress Photo</label>
            <div class="file-input-wrapper">
              <input type="file" id="photo" name="photo" class="file-input" accept="image/*">
              <label for="photo" class="file-input-label">Choose Photo</label>
            </div>
            <div class="file-name" id="fileName">No file chosen</div>
          </div>
          <div class="form-group full-width">
            <label class="form-label" for="notes">Notes (exercise, nutrition, feelings)</label>
            <textarea id="notes" name="notes" class="form-control" placeholder="How did you feel today? What exercises did you do? What did you eat?"></textarea>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Entry</button>
      </form>
    </section>

    <!-- Weight Chart -->
    <section class="chart-section">
      <h2>Weight Progress (Last 30 Days)</h2>
      <div class="chart-container">
        <canvas id="weightChart"></canvas>
      </div>
      <div class="empty-state" id="chartEmptyState" style="display: none;">
        <div class="empty-state-icon">üìä</div>
        <div>No weight data yet. Add your first entry to see your progress!</div>
      </div>
    </section>

    <!-- Timeline -->
    <section class="timeline-section">
      <h2>Your Progress Timeline</h2>
      <div class="timeline" id="timeline">
        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <div>No entries yet. Start tracking your progress by adding your first entry above!</div>
        </div>
      </div>
    </section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let weightChart = null;

    // Handle file input change
    document.getElementById('photo').addEventListener('change', function(e) {
      const fileName = e.target.files[0]?.name || 'No file chosen';
      document.getElementById('fileName').textContent = fileName;
    });

    // Load and render timeline
    async function loadTimeline() {
      try {
        const response = await fetch('{{ url_for("progress.get_entries") }}');
        const entries = await response.json();
        renderTimeline(entries);
      } catch (error) {
        console.error('Error loading timeline:', error);
      }
    }

    // Render timeline
    function renderTimeline(entries) {
      const timeline = document.getElementById('timeline');

      if (entries.length === 0) {
        timeline.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <div>No entries yet. Start tracking your progress by adding your first entry above!</div>
          </div>
        `;
        return;
      }

      timeline.innerHTML = entries.map(entry => {
        const date = new Date(entry.created_at);
        const formattedDate = date.toLocaleDateString('en-US', {
          weekday: 'short',
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        const formattedTime = date.toLocaleTimeString('en-US', {
          hour: '2-digit',
          minute: '2-digit'
        });

        const imageHtml = entry.photo_url
          ? `<img src="${entry.photo_url}" alt="Progress photo" class="entry-image">`
          : `<div class="entry-image no-image">No photo</div>`;

        const metrics = [];
        if (entry.body_fat !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Body Fat</div><div class="metric-value">${entry.body_fat}%</div></div>`);
        if (entry.water_intake !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Water</div><div class="metric-value">${entry.water_intake}L</div></div>`);
        if (entry.chest !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Chest</div><div class="metric-value">${entry.chest}cm</div></div>`);
        if (entry.waist !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Waist</div><div class="metric-value">${entry.waist}cm</div></div>`);
        if (entry.hips !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Hips</div><div class="metric-value">${entry.hips}cm</div></div>`);
        if (entry.arms !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Arms</div><div class="metric-value">${entry.arms}cm</div></div>`);
        if (entry.thighs !== null) metrics.push(`<div class="metric-item"><div class="metric-label">Thighs</div><div class="metric-value">${entry.thighs}cm</div></div>`);

        const notesHtml = entry.notes ? `
          <div class="entry-notes">
            <div class="notes-label">Notes</div>
            <div class="notes-text">${entry.notes}</div>
          </div>
        ` : '';

        return `
          <div class="timeline-entry">
            ${imageHtml}
            <div class="entry-content">
              <div class="entry-header">
                <div class="entry-date">${formattedDate} at ${formattedTime}</div>
                <div class="entry-weight">${entry.weight} kg</div>
              </div>
              <div class="entry-metrics">
                ${metrics.join('')}
              </div>
              ${notesHtml}
              <form method="POST" action="{{ url_for('progress.delete_entry', entry_id=0) }}".replace('/0', '/${entry.id}') style="margin-top: 12px;" onsubmit="return confirm('Are you sure you want to delete this entry?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn-delete-small">Delete Entry</button>
              </form>
            </div>
          </div>
        `;
      }).join('');
    }

    // Load and render chart
    async function loadChart() {
      try {
        const response = await fetch('{{ url_for("progress.get_chart_data") }}');
        const data = await response.json();
        renderChart(data);
      } catch (error) {
        console.error('Error loading chart:', error);
      }
    }

    // Render chart
    function renderChart(data) {
      const canvas = document.getElementById('weightChart');
      const emptyState = document.getElementById('chartEmptyState');

      if (data.labels.length === 0) {
        canvas.style.display = 'none';
        emptyState.style.display = 'flex';
        return;
      }

      canvas.style.display = 'block';
      emptyState.style.display = 'none';

      if (weightChart) {
        weightChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Weight (kg)',
            data: data.weights,
            borderColor: 'rgba(255, 70, 85, 1)',
            backgroundColor: 'rgba(255, 70, 85, 0.2)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 8,
            pointBackgroundColor: 'rgba(255, 70, 85, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverBackgroundColor: 'rgba(0, 217, 255, 1)',
            pointHoverBorderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(21, 27, 61, 0.95)',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 70, 85, 0.5)',
              borderWidth: 2,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return `Weight: ${context.parsed.y} kg`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: 'rgba(160, 174, 192, 0.1)',
                borderColor: 'rgba(160, 174, 192, 0.2)'
              },
              ticks: {
                color: 'rgba(160, 174, 192, 1)',
                callback: function(value) {
                  return value + ' kg';
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(160, 174, 192, 0.1)',
                borderColor: 'rgba(160, 174, 192, 0.2)'
              },
              ticks: {
                color: 'rgba(160, 174, 192, 1)'
              }
            }
          }
        }
      });
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      loadTimeline();
      loadChart();
    });
  </script>
{% endblock %}
